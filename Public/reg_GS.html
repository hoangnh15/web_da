<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="./css/reg_GS/styles.css">
    <!--<script src="./script/reg_GS/scripts.js"></script> -->


    <style>
        .address-container {
    display: flex;
    justify-content: space-between;
    }

        .form-column {
    flex: 1;
    margin-right: 10px; /* Khoảng cách giữa các cột */
        }
        .avt-setting{
            display: flex;
            

        }
        /* CSS cho menu xổ xuống */
        .dropdown {
            padding-left: 50%;
            position: relative;
            
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #4f0bce00;
            min-width: 130px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
        }
        .dropdown-content button{
            white-space: nowrap;
            font-size: medium;
            min-width: 150px;
            background-color: rgba(0, 0, 255, 0);
            border: #0a0a0a00;
            color: red;
            margin-left: 0px;
            padding: 20px; 
            text-decoration: none; 
            text-align: left;
        }

        .dropdown:hover .dropdown-content {
            
            display: block;
        }
        .dropdown-content button:hover{
            background-color: aqua;
        }
        .welcomeUsername p{
           
            padding-top: 25px;
            padding-left: 10px;
            color: rgb(255, 153, 0);

        }
        .dropdown-content a{
            white-space: nowrap;
            font-size: medium;
            min-width: 150px;
            background-color: rgba(0, 0, 255, 0);
            border: #4f0bce00;
            color: red;
            margin-left: 0px;
            padding: 0px; 
            text-decoration: none; 
            text-align: left;
        }  

    </style>
</head>
<body>
    <header>
        <a href="">
            <span class="logo-img">
                    <img src="./image/canhcut.ico" alt="">
            </span>
            <span class="logo-text">
                <span class="logo-text-tutoring">Tutor</span>
                <span class="logo-text-prodigy">Promax</span>
            </span>
        </a>
        <div class="dropdown" style="visibility: hidden;">
            <span class="logo-user">
                <img src="./image/useravt.jpg" alt="">
            </span>
            <div class="dropdown-content">
                <button id="ref_editprofile">Chỉnh sửa hồ sơ</button>
                
                <button id="btn_registeredClass">Lớp đã đăng ký</button>
                <a id= ref_quanlylop href="./registered.html">
                    <button id = "btn_createClass" >Quản lý lớp học</button>
                </a>
                <button id="logoutButton">Đăng xuất</button>
            </div>
            
        </div>
        <div class ="welcomeUsername" style="visibility: hidden;">
            <p id="username-login">Username</p>
        </div>
       
    </header>


    <div class="nav-header">
        <ul class="menu-nav">
            <li class="nav-item">
                <a href="./index.html">
                    <span>Trang chủ</span>
                </a>
            </li>
            
            <li class="nav-item">
                <a href="./service.html">
                    <span>Dịch vụ</span>
                </a>
            </li>
            
            <li class="nav-item">
                <a href="./class.html">
                    <span>Danh sách lớp mới</span>
                </a>
            </li>

            <li class="nav-item">
                <a href="./contact.html">
                    <span>Liên hệ</span>
                </a>
            </li>

            <li class="nav-item">
                <a href="./blog.html">
                    <span>Blog</span>
                </a>
            </li>
        </ul>
    </div>




    <div class="Register_HS">
        <h1 id="h1_tittle">
            CHỈNH SỬA THÔNG TIN GIA SƯ
        </h1>

        <form class="userInfoForm">
            <div class="form-column">
                <div class="avt-setting">
                    <img id="img_avt" src="./image/useravt.jpg" alt="">
                    <div>
                        <p id="status">Tài khoản đã xác thực</p>
                        <button id="edit_avt">edit avt</button>
                    </div>
                    
                </div>
                
    
                <label for="email">Email:</label>
                <input type="email" id="email" name="email" required>
    
                <label for="dob">Date of Birth:</label>
                <input type="date" id="dob" name="dob" required>
                
                <label for="education">Education Level:</label>
                <select id="education" name="education">
                    <option value="" disabled selected>Select Education Level</option>
                    <!--<option value="undergraduate">Đại học</option>
                    <option value="master">Thạc sĩ</option>
                    <option value="doctorate">Tiến sĩ</option> -->
                </select>
                <div id="cert_input">
                    <label for="certificate">Upload Certificate:</label>
                    <input type="file" id="certificate" name="certificate" accept="image/*">
                </div>
                <button type="button" class="submitButton">Submit Information</button>
                
            </div>
    
            <div class="form-column">
                
                <label for="fullname">Fullname:</label>
                <input type="text" id="fullname" name="fullname" required>
                <label for="CCCD">CCCD:</label>
                <input type="text" id="CCCD" name="CCCD" required>
    
                <label for="mobileNumber">Mobile Number:</label>
                <input type="tel" id="mobileNumber" name="mobileNumber" pattern="[0-9]{10}" placeholder="e.g., 0123456789" required>
    
                <div class="address-container">
                    <div class="form-column">
                        <label for="streetNumber">Số nhà, đường, KP:</label>
                        <input type="text" id="streetNumber" name="streetNumber" placeholder="e.g. số 01, đường Hàn Thuyên, Kp. 6" required>
                    </div>
                
                    <div class="form-column">
                        <label for="ward">Phường/Xã:</label>
                        <input type="text" id="ward" name="ward" placeholder="Linh Trung" required>
                    </div>
                
                    <div class="form-column">
                        <label for="district">Quận/Huyện/TP:</label>
                        <input type="text" id="district" name="district" placeholder="Thủ Đức" required>
                    </div>
                    <div class="form-column">
                        <label for="province">Tỉnh/TP:</label>
                        <input type="text" id="province" name="province" placeholder="Hồ Chí Minh" required>
                    </div>

                    
                </div>
                <div>
                    <h1>Lưu ý:</h1>
                    <p>
                        Dịch vụ của chúng tôi hiện tại chỉ mới hoạt động tại TP.HCM, quý khách hàng/phụ huynh- học sinh vui lòng đặt địa chỉ ở TP.HCM nhé. 
                        Kính mong quý khách thông cảm về sự bất tiện này. Tutor Promax- 1709 Company xin chân thành cảm ơn và kính chúc quý khách có một mùa Giáng sinh an lành.
                    </p>
                </div>
                
            </div>
            
    
        </form>
            
        
       <!--<script src="./script/reg_GS/script.js"></script> --> 
    </div>


    <div class="nav-contact">
            
        <div class="contact">
            <h3>Liên hệ với chúng tôi</h3>
            <p>KP6, phường Linh Trung, TP Thủ Đức, TPHCM</p>
            <p>012.345.6789</p>
            <p>Tutorprovip@gmail.com</p>
        </div>
        
        <div class="contact">
            <h3>Về tutor promax</h3>
            <p><a href="./index.html">Giới thiệu</a></p>
            <p><a href="./contact.html">Liên hệ</a></p>
            <p><a href="./contact.html">Chính sách bảo mật</a></p>
        </div>

        <div class="contact">
            <h3>Kết nối với tutor promax</h3>
            <p>Dành cho PHSS:</p>
            <p>Dành cho gia sư:</p>
            <p>Fanpage:</p>
        </div>

    </div>
<script>
    function handleSession() {
        fetch('/api/authenticated_routes/user_info')
            .then(response => response.json())
            .then(data => {
                if(data.message ==='Unauthorized'){
                    alert(data.message);
                    window.location.replace('./index.html');
                }
                if (data.userId) {
                    // Nếu đã đăng nhập
                    
                    document.querySelector('.dropdown').style.visibility = 'visible'; // Hiển thị dropdown
                    document.querySelector('.welcomeUsername p').innerText = data.username; // Hiển thị username
                    document.querySelector('.welcomeUsername').style.visibility = 'visible'; // Hiển thị phần welcomeUsername
                    const educationSelect = document.getElementById('education');
                    document.getElementById('ref_editprofile').href = './reg_GS.html'
                    
                    if(data.role===0){
                        document.getElementById('btn_createClass').style.display = 'none'; //ẩn với student
                        document.getElementById('cert_input').style.display = 'none';
                        educationSelect.innerHTML = `
                            <option value="" disabled selected>Select Education Level</option>
                            <option value="primary">Tiểu học</option>
                            <option value="second">Trung học cơ sở</option>
                            <option value="highschool">Trung học phổ thông</option>
                            `;

                        document.getElementById('h1_tittle').innerText = 'Chỉnh sửa thông tin học viên';
                        
                    }
                    else{
                        document.getElementById('ref_quanlylop').href = './reg_class.html'
                        document.getElementById('btn_registeredClass').style.display = 'none'; //ẩn với tutor

                        educationSelect.innerHTML = `
                            <option value="" disabled selected>Select Education Level</option>
                            <option value="Tốt nghiệp THPT">Tốt nghiệp THPT</option>
                            <option value="Đại học">Đại học</option>
                            <option value="Thạc sĩ">Thạc sĩ</option>
                            <option value="Tiến sĩ">Tiến sĩ</option>
                            `;
                    }

                    
                    
                } else {
                    // Nếu chưa đăng nhập
                    
                    document.querySelector('.dropdown').style.visibility = 'hidden'; // Ẩn dropdown
                    document.querySelector('.welcomeUsername').style.visibility = 'hidden'; // Ẩn phần welcomeUsername
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    // Gọi hàm kiểm tra session khi trang được load
    document.addEventListener('DOMContentLoaded', function () {
        // Kiểm tra session và load thông tin người dùng nếu đã đăng nhập
        handleSession();

        // Gọi hàm để đọc và điền thông tin vào các trường input
        loadUserInfo();
    });
    //Đăng xuất
    document.getElementById('logoutButton').addEventListener('click', function () {
    // Gọi API logout
    fetch('/api/logout', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json'
        },
    })
    .then(response => response.json())
    .then(result => {
        console.log(result);

        // Xóa cookie và session thành công, reload lại trang
        if (result.message === 'Logout successful') {
            window.location.replace('./index.html');
        } else {
            // Hiển thị thông báo lỗi nếu có
            alert('Đăng xuất không thành công.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Đã xảy ra lỗi khi thực hiện đăng xuất.');
    });
});


//load các thông tin lên form
function loadUserInfo() {

    
        // Gọi API để đọc thông tin từ cơ sở dữ liệu
        fetch('/api/get_user_info', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            },
        })
        .then(response => response.json())
        .then(userInfo => {
            if (userInfo) {
                const _date = new Date(userInfo.dob);
                _date.setDate(_date.getDate() + 1);
                const fmt_date = _date.toISOString().split('T')[0];
                // Điền thông tin vào các trường input
                document.getElementById('email').value = userInfo.email || '';
                document.getElementById('dob').value = fmt_date || '';
                document.getElementById('education').value = userInfo.edu || '';
                document.getElementById('fullname').value = userInfo.fullname || '';
                document.getElementById('CCCD').value = userInfo.CCCD || '';
                document.getElementById('mobileNumber').value = userInfo.phone_num || '';
                document.getElementById('streetNumber').value = userInfo.addr_number || '';
                document.getElementById('ward').value = userInfo.ward || '';
                document.getElementById('district').value = userInfo.district || '';
                document.getElementById('province').value = userInfo.province || '';

                document.getElementById('ref_editprofile').href = './reg_GS.html'
                if(userInfo.acc_status===0){
                    document.getElementById('status').innerText = 'Tài khoản chưa được xác thực';
                    document.getElementById('status').style.color = 'red';
                }
                console.log(userInfo.dob);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Đã xảy ra lỗi khi đọc thông tin người dùng.');
        });
    }

 //gửi DL:
 document.addEventListener('DOMContentLoaded', function () {
    // Lắng nghe sự kiện khi nút Submit được nhấn
    document.querySelector('.submitButton').addEventListener('click', function () {
        // Lấy dữ liệu từ các trường input
        const email = document.getElementById('email').value;
        const dob = document.getElementById('dob').value;
        const edu = document.getElementById('education').value;
        const fullname = document.getElementById('fullname').value;
        const CCCD = document.getElementById('CCCD').value;
        const phone_num = document.getElementById('mobileNumber').value;
        const addr_number = document.getElementById('streetNumber').value;
        const ward = document.getElementById('ward').value;
        const district = document.getElementById('district').value;
        const province = document.getElementById('province').value;
        // Kiểm tra xem có trường nào là null không
        if (!email || !dob || !fullname || !CCCD || !mobileNumber || !streetNumber || !ward || !district || !province) {
            alert('Vui lòng điền đầy đủ thông tin.');
            return;
        }

        // Gửi dữ liệu lên server
        const userInfo = {
            email,
            dob,
            edu,
            fullname,
            CCCD,
            phone_num,
            addr_number,
            ward,
            district,
            province,
        };

        fetch('/api/save_user_info', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(userInfo),
        })
        .then(response => response.json())
        .then(result => {
            console.log(result);
            alert(result.message);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Đã xảy ra lỗi khi gửi dữ liệu.');
        });
    });
});   

</script>
</body>
</html>